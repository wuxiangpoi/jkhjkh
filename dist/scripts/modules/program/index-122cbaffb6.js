"use strict";angular.module("sbAdminApp").controller("programCtrl",["$scope","$rootScope","$state","baseService","leafService",function(e,r,t,a,i){e.displayed=[],e.sp={},e.ids=[],e.leafes=[],e.currentGroup=r.rootGroup,e.sp.oid=e.currentGroup.id,e.currentLeaf={},e.currentLeaf.id="",e.sp.gid="",e.tableState={},e.callServer=function(r){a.initTable(e,r,a.api.program+"getProgramList")},e.getGroups=function(r){i.getLeafes(a.api.program+"getProgramGroups",r,function(r){e.leafes=r})},e.initPage=function(){e.callServer(e.tableState),e.ids=[]},e.$on("emitGroupLeaf",function(r,t){e.sp.oid!=t.id&&(e.currentGroup=t,e.sp.oid=t.id,e.sp.gid="",e.initPage(),e.getGroups(e.sp.oid))}),e.getGroups(e.currentGroup.id),e.addGroup=function(){i.addGroup(a.api.program+"optGroupSave",e.currentGroup.id,function(){e.getGroups(e.currentGroup.id),a.alert("添加成功","success")})},e.setGroup=function(){var r=e.ids.join(",");i.setGroup(a.api.program+"setOrganization",r,function(){e.getGroups(e.currentGroup.id),a.alert("设置成功","success"),e.initPage()})},e.chooseLeaf=function(r,t){e.currentLeaf.id=r,e.sp.gid=r,e.tableState.pagination.start=0,e.initPage()},e.setLeaf=function(){var r=e.ids.join(",");i.setLeaf(a.api.program+"setGroupRelations",e.currentGroup.id,r,e.leafes,function(){a.alert("设置成功","success",!0),e.initPage()})},e.cancelLeaf=function(){var r=e.ids.join(",");i.cancelLeaf(a.api.program+"setGroupRelations",r,e.currentLeaf,function(){a.alert("设置成功","success",!0),e.initPage()})},e.editLeaf=function(r,t){function n(){var t=c.val();""==t||t==d?(c.val(d),o.removeClass("edit")):i.editLeaf(a.api.program+"optGroupSave",{id:r.id,name:t,oid:e.currentGroup.id},function(){o.removeClass("edit"),e.getGroups(e.currentGroup.id)},function(){s.text(d),c.val(d),o.removeClass("edit")})}var o=$(t.currentTarget).parents(".leafGroup"),s=$(t.currentTarget).parents(".leafGroup").children(".leafName"),c=$(t.currentTarget).parents(".leafGroup").children(".leafEdit").children("input"),d=c.val();o.addClass("edit"),c.focus(),c.blur(function(){n()}),c.bind("keydown",function(e){var r=e||window.event;13==(r.keyCode||r.which||r.charCode)&&n()})},e.delLeaf=function(r){i.delLeaf(a.api.program+"optGroupDel",r,function(){e.getGroups(e.currentGroup.id),a.alert("删除成功","success"),e.currentLeaf={},e.currentLeaf.id="",e.sp.gid="",e.callServer(e.tableState)})},e.showProgram=function(e){e.pid=e.id,a.showProgram(e)},e.sendCommandStopProgram=function(t,i){a.confirmDialog(720,"播放管理",t,"tpl/terminal_list_modal.html",function(e,r){var i=r.ids.join(",");if(i.length){r.isPosting=!0;var n=0==r.programOrSchedule?"/api/program/programManage_sendCommand":"/api/programSchedule/scheduleManage_sendCommand",o={};o=0==r.programOrSchedule?{tids:i,type:0,pid:t.id,oid:t.oid,gid:t.gid}:{tids:i,type:0,pid:t.id},a.postData(a.api.apiUrl+n,o,function(r){e.close(),a.alert("操作成功","success",!0)})}else a.alert("请至少勾选一个终端再进行操作","warning",!0)},function(n){n.displayed=[],n.sp={},n.ids=[],n.currentGroup=r.rootGroup,n.sp.oid=n.currentGroup.id,n.currentLeaf={},n.currentLeaf.id="",n.sp.gid="",n.sp.pid=t.id,n.tableState={},n.showType=0,n.checkPerms=!1,n.programOrSchedule=0,n.callUrl=a.api.program+"getProgramPlayPageByPid",n.callServer=function(t){a.initTable(n,t,n.callUrl,function(t){t.data[0]&&(t.data[0].stype&&0!=t.data[0].stype?(r.perms(445)&&(n.checkPerms=!0),n.programOrSchedule=1):(r.perms(436)&&(n.checkPerms=!0),n.programOrSchedule=0)),n.callUrl==a.api.program+"getProgramPlayPageByPid"&&(e.displayed[i].playTers=t.recordsTotal)})},n.initTable=function(){switch(n.sp.resolution="",n.sp.status="",n.showType){case 0:n.callUrl=a.api.program+"getProgramPlayPageByPid";break;case 1:n.callUrl=a.api.program+"getProgramCommandPengdingPageByPid"}n.currentGroup=r.rootGroup,n.sp.oid=n.currentGroup.id,n.currentLeaf={},n.currentLeaf.id="",n.sp.gid="",n.callServer(n.tableState)},n.switchTab=function(e){n.showType!=e&&(n.showType=e,n.initTable())},n.$on("emitGroupLeaf",function(e,r,t){n.sp.oid==r.id&&n.sp.gid==t.id||(n.currentGroup=r,n.sp.oid=r.id,n.sp.gid=t.id,n.callServer(n.tableState))}),n.checkAll=function(e){if(n.ids=[],$(e.currentTarget).is(":checked"))for(var r=0;r<n.displayed.length;r++)n.ids.push(n.displayed[r].tid);else n.ids=[]},n.checkThis=function(e,r){$(r.currentTarget).is(":checked")?n.ids.push(e.tid):n.ids=a.removeAry(n.ids,e.tid)}})},e.sendDown=function(e){a.confirmDialog(820,"发布",e,"tpl/terminal_list_set_modal.html",function(r,t){var i=t.ids.join(",");i.length?t.data.endDate>t.data.startDate?t.showTip?a.alert("请选择正确的播放时间段","warning",!0):(t.isPosting=!0,a.postData(a.api.program+"programManage_sendCommand",{tids:i,type:1,pid:e.id},function(){r.close(),a.alert("发布成功","success",!0),t.callServer(t.tableState)})):a.alert("请选择正确的播放日期","warning",!0):a.alert("请至少勾选一个终端再进行操作","warning",!0)},function(t){function i(e){return e<10?"0"+e.toString():e.toString()}t.displayed=[],t.sp={},t.ids=[],t.currentGroup=r.rootGroup,t.sp.oid=t.currentGroup.id,t.currentLeaf={},t.currentLeaf.id="",t.sp.gid="",t.sp.pid=e.id,t.tableState={},t.start_h=0,t.start_m=0,t.end_h=24,t.end_m=0,t.showTip=!1,t.selectH=[],t.selectM=[];var n=new Date;t.today=n.getFullYear()+"-"+a.formateDay(n.getMonth()+1)+a.formateDay(n.getDate());for(var o=0;o<25;o++)t.selectH.push({name:o+"时",value:o});for(var o=0;o<60;o++)t.selectM.push({name:o+"分",value:o});t.callServer=function(e){a.initTable(t,e,a.api.program+"programManage_getAllOkTerminalList")};var s=new Date,c=s.getFullYear(),d=s.getMonth()+1,p=s.getDate();t.data.startDate=c.toString()+i(d)+i(p.toString()),t.data.endDate=(c+1).toString()+i(d)+i(p.toString()),t.formDate=function(e,r,a){t.data[a]=e._i.split("-").join("")},t.checkTime=function(){24==t.start_h&&(t.start_m=0),24==t.end_h&&(t.end_m=0),parseFloat(t.end_h+t.end_m/60)<=parseFloat(t.start_h+t.start_m/60)?t.showTip=!0:t.showTip=!1},t.$on("emitGroupLeaf",function(e,r,a){t.sp.oid==r.id&&t.sp.gid==a.id||(t.currentGroup=r,t.sp.oid=r.id,t.sp.gid=a.id,t.callServer(t.tableState))}),t.checkAll=function(e){a.checkAll(e,t)},t.checkThis=function(e,r){a.checkThis(e,r,t)}})},e.del=function(r){a.confirm("删除","确定删除节目："+r.name+"?",function(t,i){i.isPosting=!0,a.postData(a.api.program+"deleteProgram",{id:r.id},function(r){t.close(),a.alert("删除成功","success"),e.callServer(e.tableState)})})},e.submitCheck=function(r){a.confirm("提交审核","是否提交审核？",function(t,i){i.isPosting=!0,a.postData(a.api.program+"sumbmitCheck",{id:r.id},function(r){t.close(),a.alert("提交成功","success"),e.callServer(e.tableState)})})},e.saveEdit=function(e){t.go("dashboard.programEdit",{id:e.id})},e.saveAs=function(e){t.go("dashboard.programCopy",{id:e.id})},e.checkAll=function(r){a.checkAll(r,e)},e.checkThis=function(r,t){a.checkThis(r,t,e)},e.showTip=function(e){$(e.currentTarget).children(".btn").hasClass("disabled")&&$(e.currentTarget).children(".tipDiv").show()},e.hideTip=function(e){$(e.currentTarget).children(".tipDiv").hide()}}]);