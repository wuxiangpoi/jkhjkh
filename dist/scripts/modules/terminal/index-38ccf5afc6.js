"use strict";angular.module("sbAdminApp",["chartService"]).controller("terminalCtrl",["$scope","$rootScope","$stateParams","baseService","leafService","chartService","ngDialog",function(e,a,t,i,r,n,s){function o(){var a="";for(var t in e.sp)e.sp[t]&&(a+="&"+t+"="+e.sp[t]);return a&&(a="?"+a.substr(1)),a}e.displayed=[],e.sp={},e.tableState={},e.ids=[],e.idsNormal=[],e.leafes=[],e.currentGroup=a.rootGroup,e.sp.oid=e.currentGroup.id,e.currentLeaf={},e.currentLeaf.id="",e.sp.gid="",e.netStatus=[{name:"终端状态",value:""},{name:"未激活",value:"0"},{name:"在线",value:"1"},{name:"离线",value:"2"},{name:"异常",value:"3"}],e.init_status=t.status,t.status&&(e.sp.status=parseInt(t.status)),e.callServer=function(a){e.ids=[],e.idsNormal=[],i.initTable(e,a,i.api.terminal+"getTerminalPageList")},e.getTerminalGroups=function(a){r.getLeafes(i.api.terminal+"getTerminalGroups",a,function(a){e.leafes=a})},e.initPage=function(){e.tableState.pagination.start=0,e.ids=[],e.idsNormal=[],e.callServer(e.tableState)},e.$on("emitGroupLeaf",function(a,t){e.sp.oid!=t.id&&(e.currentGroup=t,e.sp.oid=t.id,e.sp.gid="",e.initPage(),e.getTerminalGroups(e.sp.oid))}),e.getTerminalGroups(e.currentGroup.id),e.addGroup=function(){r.addGroup(i.api.terminal+"optGroupSave",e.currentGroup.id,function(){e.getTerminalGroups(e.currentGroup.id),i.alert("添加成功","success")})},e.setGroup=function(){var a=e.ids.join(",");r.setGroup(i.api.terminal+"setOrganization",a,function(){e.getTerminalGroups(e.currentGroup.id),i.alert("设置成功","success"),e.initPage()})},e.chooseLeaf=function(a,t){e.currentLeaf.id=a,e.sp.gid=a,e.initPage()},e.setLeaf=function(){var a=e.ids.join(",");r.setLeaf(i.api.terminal+"setGroupRelations",e.currentGroup.id,a,e.leafes,function(){i.alert("设置成功","success",!0),e.initPage()})},e.cancelLeaf=function(){var a=e.ids.join(",");r.cancelLeaf(i.api.terminal+"setGroupRelations",a,e.currentLeaf,function(){i.alert("设置成功","success",!0),e.initPage()})},e.editLeaf=function(a,t){function n(){var t=l.val();""==t||t==d?(l.val(d),s.removeClass("edit")):r.editLeaf(i.api.terminal+"optGroupSave",{id:a.id,name:t,oid:e.currentGroup.id},function(){s.removeClass("edit"),e.getTerminalGroups(e.currentGroup.id)},function(){o.text(d),l.val(d),s.removeClass("edit")})}var s=$(t.currentTarget).parents(".leafGroup"),o=$(t.currentTarget).parents(".leafGroup").children(".leafName"),l=$(t.currentTarget).parents(".leafGroup").children(".leafEdit").children("input"),d=l.val();s.addClass("edit"),l.focus(),l.blur(function(){n()}),l.bind("keydown",function(e){var a=e||window.event;13==(a.keyCode||a.which||a.charCode)&&n()})},e.delLeaf=function(a){r.delLeaf(i.api.terminal+"optGroupDel",a,function(){e.getTerminalGroups(e.currentGroup.id),i.alert("删除成功","success"),e.currentLeaf={},e.currentLeaf.id="",e.sp.gid="",e.callServer(e.tableState)})},e.details=function(e){i.getJson(i.api.terminal+"getTerminalInfo",{tid:e.id},function(e){i.confirmDialog(580,"终端状态信息",e,"tpl/terminal_details.html",function(e){e.close()})})},e.save=function(t){var r={name:t?t.name:"",no:t?t.no:"",id:t?t.id:"",city_no:t?t.city_no:"",remark:t?t.remark:"",cityName:"",addr:t?t.addr:""};i.confirmDialog(580,t?"编辑终端信息":"添加终端",r,"tpl/terminal_save.html",function(r,n){if(n.modalForm.$valid){var s={name:n.data.name,id:n.data.id,city_no:n.data.city_no,remark:n.data.remark?n.data.remark:"",cityName:"",addr:n.data.addr};n.isPosting=!0,i.postData(i.api.terminal+"modifyTerminalInfo",s,function(n){a.userData.root_citys=n,r.close(),e.callServer(e.tableState),i.alert(t?"修改成功":"添加成功","success")},function(e){n.isPosting=!1,i.alert(e,"warning",!0)})}else n.isShowMessage=!0})},e.sendCommand=function(t){var r=e.idsNormal.join(",");switch(t){case 2:case 3:var n={command:t};if(1==e.idsNormal.length){for(var s={},o=0;o<e.displayed.length;o++)e.displayed[o].id==r&&(s=e.displayed[o]);if(3==t)n.volumn=s.volumn;else if(s.workCron){var l=s.workCron.split("/")[0],d=s.workCron.split("/")[1];n.start_h=parseInt(l.split(" ")[2]),n.start_m=parseInt(l.split(" ")[1]),n.end_h=parseInt(d.split(" ")[2]),n.end_m=parseInt(d.split(" ")[1]);var c=l.split(" ")[5];n.weeks="*"==c?"1,2,3,4,5,6,7":c}}i.confirmDialog(450,a.getRootDicName("terminal_cmd",t),n,"tpl/terminal_command.html",function(a,n){var s={tids:r,command:t};3==t?n.modalForm.$valid?(n.isPosting=!0,s.volumn=n.data.volumn,n.isPosting=!0,i.postData(i.api.terminal+"sendCommand",s,function(t){a.close(),i.alert("设置成功","success"),e.callServer(e.tableState)})):n.isShowMessage=!0:n.modalForm.$valid&&60*n.data.end_h+n.data.end_m>=60*n.data.start_h+n.data.start_m?(n.isPosting=!0,s.start_h=n.data.start_h,s.start_m=n.data.start_m,s.end_h=n.data.end_h,s.end_m=n.data.end_m,s.week="1,2,3,4,5,6,7".split(","),i.postData(i.api.terminal+"sendCommand",s,function(t){a.close(),i.alert("设置成功","success"),e.callServer(e.tableState)})):n.isShowMessage=!0},function(e){e.selectH=[],e.selectM=[];for(var a=0;a<25;a++)e.selectH.push({name:a+"时",value:a});for(var a=0;a<60;a++)e.selectM.push({name:a+"分",value:a});e.checkTime=function(){24==e.data.start_h&&(e.data.start_m=0),24==e.data.end_h&&(e.data.end_m=0)}});break;case 4:case 7:case 8:i.confirm("终端操作","确定对当前选中的设备执行命令："+a.getRootDicName("terminal_cmd",t)+"?",function(e,a){a.isPosting=!0,i.postData(i.api.terminal+"sendCommand",{tids:r,command:t},function(a){e.close(),i.alert("命令执行成功后，可在终端详情中查看","success")})})}},e.checkAll=function(a){if(e.ids=[],e.idsNormal=[],$(a.currentTarget).is(":checked"))for(var t=0;t<e.displayed.length;t++)e.ids.push(e.displayed[t].id),1==e.displayed[t].status&&e.idsNormal.push(e.displayed[t].id);else e.ids=[],e.idsNormal=[]},e.checkThis=function(a,t){$(t.currentTarget).is(":checked")?(e.ids.push(a.id),1==a.status&&e.idsNormal.push(a.id)):(e.ids=i.removeAry(e.ids,a.id),e.idsNormal=i.removeAry(e.idsNormal,a.id))},e.showPrograms=function(t,r){t.info="(同一终端上的节目与排期互斥)",i.confirmDialog(720,"播放管理",t,"tpl/terminal_programPlay_list.html",function(e,a){var r="";r=a.ids.join(",");var n=0==a.programOrSchedule?"节目":"排期";r.length?i.confirm("节目操作","确定在该设备上停播选中"+n+"?",function(e,n){n.isPosting=!0;var s=0==a.programOrSchedule?"/api/program/programManage_sendCommand_StopPlayByPids":"/api/programSchedule/scheduleManage_sendCommand",o={};o=0==a.programOrSchedule?{tid:t.id,type:0,pids:r}:{tids:t.id,type:0,pid:r},i.postData(i.api.apiUrl+s,o,function(a){e.close(),i.alert("操作成功","success",!0)})}):i.alert("请至少勾选一个"+n+"再进行操作","warning",!0)},function(s){s.displayed=[],s.sp={},s.sp.tid=t.id,s.tableState={},s.ids=[],s.showType=0,s.checkPerms=!1,s.programOrSchedule=0,s.callUrl=i.api.terminal+"getTerminalProgramPlayPageByTid",s.callServer=function(t){i.initTable(s,t,s.callUrl,function(t){t.data[0]&&(t.data[0].stype&&0!=t.data[0].stype?(a.perms(217)&&(s.checkPerms=!0),s.programOrSchedule=1,s.callUrl==i.api.terminal+"getTerminalProgramPlayPageByTid"&&(e.displayed[r].programCounts=t.data[0].programCounts)):(a.perms(217)&&(s.checkPerms=!0),s.callUrl==i.api.terminal+"getTerminalProgramPlayPageByTid"&&(e.displayed[r].programCounts=t.recordsTotal),s.programOrSchedule=0))})},s.initTable=function(){switch(s.showType){case 0:s.callUrl=i.api.terminal+"getTerminalProgramPlayPageByTid";break;case 1:s.callUrl=i.api.terminal+"getTerminalProgramCommandPengdingPageByTid"}s.callServer(s.tableState)},s.switchTab=function(e){s.showType!=e&&(s.showType=e,s.initTable())},s.checkAll=function(e){if(s.ids=[],$(e.currentTarget).is(":checked"))for(var a=0;a<s.displayed.length;a++)s.ids.push(s.displayed[a].pid);else s.ids=[]},s.checkThis=function(e,a){$(a.currentTarget).is(":checked")?s.ids.push(e.pid):s.ids=i.removeAry(s.ids,e.pid)},s.showProgramOrSchedule=function(e){1==s.showType?24==e.cmdCode||25==e.cmdCode?(e.id=e.pid,i.showSchedule(e,2,n)):(e.pStatus=1,i.showProgram(e)):e.stype&&1==e.stype?(e.id=e.pid,i.showSchedule(e,2,n)):(e.pStatus=1,i.showProgram(e))}})},e.showTip=function(e){$(e.currentTarget).children(".btn").hasClass("disabled")&&$(e.currentTarget).children(".tipDiv").show()},e.hideTip=function(e){$(e.currentTarget).children(".tipDiv").hide()},e.exportExcel=function(){i.confirm("导出表格","确定将当前查询的所有的设备信息导出excel表格?",function(e){e.close(),window.open(i.api.terminal+"exportTerminal"+o())})},e.dealAbnormal=function(a){i.confirmDialog(540,"处理异常终端",a,"tpl/dealAbnormal.html",function(t,r){r.isPosting=!0,i.postData(i.api.terminal+"sendCommand",{tids:a.id,command:9},function(a){t.close(),i.alert("处理成功","success"),e.initPage()})})}}]);