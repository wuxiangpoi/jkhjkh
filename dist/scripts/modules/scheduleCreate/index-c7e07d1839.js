"use strict";angular.module("sbAdminApp",["chartService"]).controller("scheduleCreateCtrl",["$scope","$rootScope","$state","$stateParams","baseService","leafService","chartService",function(e,t,a,r,i,s,m){function o(e){return e<10?"0"+e.toString():e.toString()}function n(){var t=14;e.playList.length>t&&(t=e.playList.length),e.chartStyle={height:30*t+30+"px",width:"100%"},e.eoption=m.initChartSchedule(e.playList,t),setTimeout(function(){e.$apply()},1)}function p(t){function a(e,t,a,r,s){return"date"==s&&(e=i.formateDayTime(e),t=i.formateDayTime(t),a=i.formateDayTime(a),r=i.formateDayTime(r),t+=864e5,r+=864e5),a==e&&r==t?"date"==s:!(r<=e)&&(!(r>e&&a>=t)&&(!(a>=t)&&!(a<t&&r<=e)))}var r={check:!1};if(0==t.stype)return r;if(r.cross=[],!(60*(t.eTime-t.sTime)<t.duration*t.plays)){for(var s=0;s<e.playList.length;s++)if(1==e.playList[s].stype&&a(t.sTime,t.eTime,e.playList[s].sTime,e.playList[s].eTime,"time")&&a(t.startDate,t.endDate,e.playList[s].startDate,e.playList[s].endDate,"date")){var m=e.playList[s];m.msg={type:3,info:"暂不能添加交叉时段，此时段与已添加的"+e.playList[s].startTime+"至"+e.playList[s].endTime+"交叉，请重新选择时段"},r.cross.push(m)}if(r.cross.length>0)return r.check=!0,r;for(var o=(i.formateDayTime(t.endDate)-i.formateDayTime(t.startDate))/c,m={},s=0;s<=o;s++)if(h[i.formateDayTime(t.startDate)+s*c][t.timeSel])if(h[i.formateDayTime(t.startDate)+s*c][t.timeSel].minuteRemain-t.duration*t.plays<0){var n=new Date(i.formateDayTime(t.startDate)+s*c),p=n.getFullYear()+"-"+i.formateDay(n.getMonth()+1)+"-"+i.formateDay(n.getDate());m.date?m.dateInterval=m.date+"至"+p:m={date:p},m.msg={type:5,info:m.dateInterval?m.dateInterval+"的"+t.startTime+"至"+t.endTime+"剩余时长不足~":m.date+"的"+t.startTime+"至"+t.endTime+"剩余时长不足~"}}else h[i.formateDayTime(t.startDate)+s*c][t.timeSel]={minuteRemain:h[i.formateDayTime(t.startDate)+s*c][t.timeSel].minuteRemain-t.duration*t.plays};else h[i.formateDayTime(t.startDate)+s*c][t.timeSel]={minuteRemain:60*(t.eTime-t.sTime)-t.duration*t.plays};return m.date&&r.cross.push(m),r.cross.length>0&&(r.check=!0),r}var m=t,d=t.startDate==t.startDate?i.formateDayTime(t.startDate,"date"):i.formateDayTime(t.startDate,"date")+"-"+i.formateDayTime(t.startDate,"date");return m.msg={type:4,info:d+"的"+t.startTime+"至"+t.endTime+"剩余时长不足~"},r.cross.push(m),r.cross.length>0?(r.check=!0,r):void 0}e.displayed=[],e.sp={},e.ids=[],e.leafes=[],e.currentGroup=t.rootGroup,e.sp.oid=e.currentGroup.id,e.currentLeaf={},e.currentLeaf.id="",e.sp.gid="",e.sp.status=1,e.tableState={},e.playList=[],e.playListId=[],e.isShowMessage=!1;for(var d=new Date,l=d.getFullYear(),D=d.getMonth()+1,y=d.getDate(),u=new Date,c=864e5,f=u.getFullYear()+"-"+i.formateDay(u.getMonth()+1)+"-"+i.formateDay(u.getDate()),g=u.getFullYear()+1+"-"+i.formateDay(u.getMonth()+2)+i.formateDay(u.getDate()),T=l.toString()+o(D)+o(y.toString()),h=((l+1).toString(),o(D),o(y.toString()),{}),S=0;S<400;S++){Date.parse(f),u.getFullYear(),i.formateDay(u.getMonth()+1),i.formateDay(u.getDate());h[Date.parse(f)+S*c]={}}r.id&&i.postData(i.api.programSchedule+"getProgramScheduleById",{id:r.id},function(t){function a(t){if(e.playListId.push(t.id),e.playList.push(t),i.formateDayTime(t.startDate)<Date.parse(f)&&(t.startDate=f.split("-").join("")),1==t.stype){t.sTime=parseInt(60*t.startTime.split(":")[0])+parseInt(t.startTime.split(":")[1]),t.eTime=parseInt(60*t.endTime.split(":")[0])+parseInt(t.endTime.split(":")[1]);for(var a=(i.formateDayTime(t.endDate)-i.formateDayTime(t.startDate))/c,r=0;r<=a;r++)h[i.formateDayTime(t.startDate)+r*c][t.timeSel]?h[i.formateDayTime(t.startDate)+r*c][t.timeSel]={minuteRemain:h[i.formateDayTime(t.startDate)+r*c][t.timeSel].minuteRemain-t.duration*t.plays}:h[i.formateDayTime(t.startDate)+r*c][t.timeSel]={minuteRemain:60*(t.eTime-t.sTime)-t.duration*t.plays}}}for(var s=0;s<t.programs.length;s++){var m={id:t.programs[s].id,name:t.programs[s].name,size:t.programs[s].size,materials:t.programs[s].materials,duration:t.programs[s].duration,content:t.programs[s].content,startDate:t.programs[s].startDate.toString(),endDate:t.programs[s].endDate.toString(),stype:t.programs[s].stype};1==t.programs[s].stype&&(m.startTime=t.programs[s].startTime,m.endTime=t.programs[s].endTime,m.plays=t.programs[s].plays),"saveAs"==r.type||r.id?i.formateDayTime(m.endDate)>=Date.parse(f)&&a(m):a(m)}r.id&&"saveAs"!=r.type&&(e.scheduleName=t.name),r.pos&&(e.schedulePos=r.pos),n()}),e.callServer=function(t){i.initTable(e,t,i.api.program+"getProgramList")},e.initPage=function(){e.callServer(e.tableState)},e.$on("emitGroupLeaf",function(t,a,r){e.sp.oid==a.id&&e.sp.gid==r.id||(e.currentGroup=a,e.sp.oid=a.id,e.sp.gid=r.id,e.initPage())}),e.showProgram=function(e){e.pid=e.id,i.showProgram(e)},e.add=function(t){i.confirmDialog(540,"添加排期",{},"tpl/add_schedule.html",function(a,r){if(r.modalForm.$valid&&!r.showTip&&r.data.endDate>=r.data.startDate){var s={id:t.id,name:t.name,size:t.size,materials:t.materials,duration:t.duration,content:t.content,startDate:r.data.startDate,endDate:r.data.endDate,stype:r.stype};1==r.stype&&(s.sTime=60*r.start_h+r.start_m,s.eTime=60*r.end_h+r.end_m,s.timeSel=s.sTime+"-"+s.eTime,s.startTime=i.formateDay(r.start_h)+":"+i.formateDay(r.start_m),s.endTime=i.formateDay(r.end_h)+":"+i.formateDay(r.end_m),s.plays=r.data.plays);var m=p(s);m.check?i.confirmAlert("提示",m.cross[0].msg.info,"warning"):(a.close(),e.playListId.push(s.id),e.playList.push(s),n())}else r.isShowMessage=!0},function(e){e.instructions="<p>1、如果排期中只有全天轮播，则每个节目轮流播放。</p>",e.instructions+="<p>2、如果排期中只有按次数轮播，则按次数轮播节目在设置的时段内按比例轮播，在设置以外的时段轮流播放。如：节目A设置9:00-12:00至少播5次，节目B设置9:00-12:00至少播10次，则9:00-12:00内，节目B每播2次，节目A播1次，9:00-12:00以外的时段则按1:1轮流播放。</p>",e.instructions+="<p>3、如果排期中包含以上二种播放方式，则按次数轮播节目只在设置时段内播，其它时段播放全天轮播节目。如：节目A、B按次数轮播，时段为9:00-12:00，节目C全天轮播，则9:00-12:00播节目A、B，其它时段播节目C。</p>",e.start_h=0,e.start_m=0,e.end_h=24,e.end_m=0,e.showTip=!1,e.selectH=[],e.selectM=[];new Date;e.today=f,e.maxDate=g;for(var t=0;t<25;t++)e.selectH.push({name:t+"时",value:t});for(var t=0;t<60;t++)e.selectM.push({name:t+"分",value:t});e.data.startDate=T,e.data.endDate="",e.stype=0,e.formDate=function(t,a,r){e.data[r]=t._i.split("-").join("")},e.checkTime=function(){24==e.start_h&&(e.start_m=0),24==e.end_h&&(e.end_m=0),parseFloat(e.end_h+e.end_m/60)<=parseFloat(e.start_h+e.start_m/60)?e.showTip=!0:e.showTip=!1}})},e.saveSchedule=function(){e.scheduleNameForm.$valid?i.confirm("提示","确定保存排期："+e.scheduleName+"?",function(t,a){a.isPosting=!0,i.postData(i.api.programSchedule+"saveProgramSchedule",{id:"saveAs"!=r.type&&r.id?r.id:"",name:e.scheduleName,programs:JSON.stringify(e.playList)},function(e){i.alert("添加成功","success"),i.goToUrl("dashboard/schedule")})}):(e.isShowMessage=!0,window.scrollTo(0,0))},e.del=function(t){if(1==t.stype)for(var a=(i.formateDayTime(t.endDate)-i.formateDayTime(t.startDate))/c,r=0;r<=a;r++)h[i.formateDayTime(t.startDate)+r*c][t.timeSel]={minuteRemain:h[i.formateDayTime(t.startDate)+r*c][t.timeSel].minuteRemain+t.duration*t.plays};e.playList=i.removeAryId(e.playList,t.id),e.playListId=i.removeAry(e.playListId,t.id),n()}}]);